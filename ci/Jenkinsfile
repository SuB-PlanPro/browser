pipeline {
  agent {
    kubernetes {
      yamlFile 'ci/kubernetes.yaml'
    }
  }

  options {
    timeout(time: 20, unit: 'MINUTES')
    buildDiscarder(logRotator(numToKeepStr: '10'))
  }

  stages {
    stage('Build Rust') {
      steps {
        container('rust') {
          dir('cef/Release')
          {
            downloadCEF versionFile: '../../CEF_VERSION.txt', files: ['Release/libcef.lib']
          }

          sh 'rustup target add x86_64-pc-windows-gnu'
          dir('native')
          {
            sh 'cargo clean'
            sh 'cargo build --release --target x86_64-pc-windows-gnu'
          }

          dir('native/target/x86_64-pc-windows-gnu/release')
          {
            stash name: 'rust_binaries', includes: 'chromium_subp.exe, chromium_jni.dll', useDefaultExcludes: false
          }
        }
      }
    }

    stage('Build Java') {
      steps {
        container('maven') {
          dir('java/org.eclipse.set.browser.lib/res')
          {
            unstash 'rust_binaries'
          }

          dir('java')
          {
            mvn goal: 'clean integration-test'
          }
        }
      }
    }

    stage('Deploy Snapshot')
    {
      when {
        anyOf {
          buildingTag()
          branch 'main'
        }
      }

      steps {
        deployP2Site name: 'browser', path: 'java/bundles/org.eclipse.set.browser.releng.repository/target/repository' 
      }
    }
  }
}